<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'none'; script-src 'nonce-{{nonce}}'; style-src 'unsafe-inline';"
    />
    <title>Branch Review</title>
    {{cssPlaceholder}}
  </head>
  <body
    data-controller="app search"
    data-action="comments:updated->app#handleCommentsUpdated keydown->search#handleGlobalKeydown"
  >
    <div class="br-header" data-controller="sticky" data-sticky-target="header">
      <div class="br-header-content">
        <div class="br-header-left">
          <h1 class="br-header-title">
            Comparing
            <div
              class="branch-selector"
              data-controller="branch"
              data-branch-branches-value="{{branchesArray}}"
              data-branch-selected-value="{{baseBranch}}"
              data-branch-current-value="{{currentBranch}}"
            >
              <div class="branch-input-wrapper">
                <input
                  type="text"
                  class="branch-input"
                  placeholder="Select base branch..."
                  value="{{baseBranch}}"
                  readonly
                  data-branch-target="input"
                  data-action="click->branch#toggle keydown->branch#handleKeydown"
                />
                <svg
                  class="branch-arrow"
                  width="16"
                  height="16"
                  viewBox="0 0 16 16"
                  fill="currentColor"
                >
                  <path
                    d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"
                  />
                </svg>
              </div>
              <div class="branch-dropdown" data-branch-target="dropdown">
                <div class="branch-search">
                  <input
                    type="text"
                    class="branch-search-input"
                    placeholder="Search branches..."
                    data-branch-target="searchInput"
                    data-action="input->branch#search keydown->branch#handleKeydown"
                  />
                </div>
                <div class="branch-list" data-branch-target="list">
                  <!-- Branches will be rendered here -->
                </div>
              </div>
            </div>
            <span class="br-ellipsis">...</span>
            <span class="br-current-branch">{{currentBranch}}</span>
          </h1>
          <div class="br-refresh-section">
            <button
              class="br-btn br-btn-refresh"
              data-action="click->app#refreshDiff"
              data-app-target="refreshButton"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 16 16"
                fill="currentColor"
                style="margin-right: 6px"
              >
                <path
                  d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z"
                />
              </svg>
              Refresh
            </button>
          </div>
        </div>
        <div class="br-header-right">
          <div class="br-controls">
            <!-- Comment Navigation -->
            <div class="br-comment-navigation" data-controller="comment-navigation">
              <span class="br-comment-count" data-comment-navigation-target="count"
                >No comments</span
              >
              <div class="br-comment-nav-buttons">
                <button
                  class="br-btn br-btn-sm"
                  data-comment-navigation-target="prevButton"
                  data-action="click->comment-navigation#navigateToPrevious"
                  title="Previous comment"
                  disabled
                >
                  â†‘
                </button>
                <button
                  class="br-btn br-btn-sm"
                  data-comment-navigation-target="nextButton"
                  data-action="click->comment-navigation#navigateToNext"
                  title="Next comment"
                  disabled
                >
                  â†“
                </button>
              </div>
            </div>

            <button
              class="br-btn br-btn-danger"
              data-action="click->app#deleteAllComments"
              data-app-target="deleteAllButton"
              title="Delete all comments in this diff"
              disabled
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 16 16"
                fill="currentColor"
                style="margin-right: 4px"
              >
                <path
                  d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.748 1.748 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.149ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z"
                />
              </svg>
              Delete All Comments
            </button>

            <button
              class="br-btn br-btn-primary"
              data-action="click->app#submitComments"
              data-app-target="submitButton"
              disabled
            >
              ðŸš€ Submit Review to Chat
            </button>
          </div>
          <div class="br-diff-stats-section">
            <div class="br-diff-stats">{{diffStats}}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Interface -->
    <div
      id="searchContainer"
      class="search-container"
      style="display: none"
      data-search-target="container"
    >
      <div class="search-box">
        <input
          type="text"
          class="search-input"
          placeholder="Search in diff..."
          data-search-target="input"
          data-action="input->search#search keydown->search#searchOnEnter"
        />
        <div class="search-controls">
          <span class="search-results" data-search-target="results">0 of 0</span>
          <button
            class="search-btn"
            title="Previous (Shift+Enter)"
            data-action="click->search#navigateToPrevMatch"
          >
            â†‘
          </button>
          <button
            class="search-btn"
            title="Next (Enter)"
            data-action="click->search#navigateToNextMatch"
          >
            â†“
          </button>
          <button class="search-btn" title="Close search (Esc)" data-action="click->search#close">
            Ã—
          </button>
        </div>
      </div>
    </div>

    <!-- Loading state -->
    <div
      id="loadingState"
      class="loading-container"
      style="display: none"
      data-app-target="loadingState"
    >
      <div class="loading-content">
        <h3>Loading branch review...</h3>
        <p id="loadingStatus">Initializing Git operations...</p>
      </div>
    </div>

    <!-- Main content -->
    <div
      id="mainContent"
      style="width: 100%; margin: 0; padding: 24px; box-sizing: border-box"
      data-app-target="mainContent"
    >
      {{diffContent}}
    </div>

    <!-- Import map must be loaded before any module scripts -->
    <script nonce="{{nonce}}" type="importmap">
      {
        "imports": {
          "stimulus": "./stimulus.min.js"
        }
      }
    </script>

    <script nonce="{{nonce}}" type="module" src="./events.js"></script>
    <script nonce="{{nonce}}" type="module" src="./app.js"></script>
  </body>
</html>
